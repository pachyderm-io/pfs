#!/bin/bash

set -e

# This file isn't autogenerated so we need to keep it around:
cp doc/pachctl/index.rst .
rm -rf doc/pachctl && mkdir doc/pachctl
$GOPATH/bin/pachctl-doc

# Place the index back in
mv index.rst doc/pachctl

VERSION="$(cat VERSION)"
MAJOR_MINOR=`echo $VERSION | cut -f -2 -d "."`
echo "--- Updating docs for version: $VERSION"

# Remove "see also" sections, since they have bad links and aren't very
# helpful here anyways
# NOTE: this could be done cleaner with `find -exec sed`, like below, but
# `sed -i` doesn't seem to play well with the cross-platform method we're
# using here to remove everything after the see also pattern
for srcpath in doc/pachctl/*.md; do
	#dstpath=doc/pachctl-fixed/$(basename $srcpath)
	sed -n '/### SEE ALSO/!p;//q' $srcpath > tmp.md
	mv tmp.md $srcpath
done

# Update deb URL
NEW_DEB_URL="pachyderm/releases/download/v${VERSION}/pachctl_${VERSION}_amd64.deb"
find doc -type f -exec sed -i'' 's@pachyderm\/releases\/download\/v.*\/pachctl_.*_amd64.deb@'"$NEW_DEB_URL"'@g' {} \;

# Update 'other linux flavors' URL
NEW_URL="pachyderm/releases/download/v${VERSION}/pachctl_${VERSION}_linux_amd64.tar.gz"
find doc -type f -exec sed -i'' 's@pachyderm\/releases\/download\/v.*\/pachctl_.*_linux_amd64.tar.gz@'"$NEW_URL"'@g' {} \;
# also need to replace the version elsewhere in that command:
find doc -type f -exec sed -i'' 's@tmp\/pachctl_.*_linux_amd64\/pachctl@'"tmp/pachctl_${VERSION}_linux_amd64/pachctl"'@g' {} \;

# Update brew formula (only needed when MAJOR_MINOR changes)
find doc -type f -exec sed -i'' 's#pachyderm/tap/pachctl.*#pachyderm/tap/pachctl@'"$MAJOR_MINOR"'#g' {} \;

echo "--- Successfully updated docs"
